#include <WiFi.h>        // conectar a WiFi
#include <HTTPClient.h>  // enviar datos a la API (como mandar un mensaje).
#include <MFRC522.h>     // Biblioteca para leer tarjetas RFID (como un lector de códigos).
#include <ArduinoJson.h>

// Pines para el lector RFID (conecta cables aquí).
#define SS_PIN 5   // Pin para seleccionar el lector RFID (naranja)
#define RST_PIN 0  // Pin para resetear el lector RFID (amarillo)
// Crea el objeto RFID con los pines.
MFRC522 rfid(SS_PIN, RST_PIN);

// Configura WiFi
const char* ssid = "PEINE-3";  //NOMBRE DE RED
const char* password = "etecPeine3";
// URL de tu API Flask (corre Flask en localhost:5000).
const char* serverUrl = "http://10.56.13.22:5000/registro";

void setup() {
  Serial.begin(115200);  // Inicia comunicación con la computadora (para ver mensajes).
  SPI.begin();           // Inicia SPI (como un bus para conectar dispositivos).
  rfid.PCD_Init();       // Enciende el lector RFID (lo prepara para leer tarjetas).
//Recomendacion, usar un while si no hay wifi
  Serial.println("conectando a wifi");
  WiFi.begin(ssid, password);              // Conecta a WiFi.
  while (WiFi.status() != WL_CONNECTED) {  // Espera hasta conectar.
  Serial.print(".");
    delay(1000);                           // Espera 1 segundo.
  }
  Serial.println("Conectado a WiFi!");  // Mensaje de éxito.
  Serial.println("setupok!");  // Mensaje de éxito.
}

void loop() {
  // Revisa si hay una tarjeta cerca.
  if (!rfid.PICC_IsNewCardPresent() || !rfid.PICC_ReadCardSerial()) {
    return;  // Si no hay tarjeta, vuelve al inicio.
  }
  // Lee el código único de la tarjeta (UID).
  String uid = "";                            // Variable para guardar el UID.
  for (byte i = 0; i < rfid.uid.size; i++) {  // Recorre cada parte del UID.
    uid += String(rfid.uid.uidByte[i], HEX);  // Convierte a letras/números y agrega.
  }
  Serial.println("Tarjeta leída: " + uid);  //LEER LA TARJETA
  //PARA AGINAR ESA INFO A UN ID_EMPLEADO

  if (WiFi.status() == WL_CONNECTED) {  // Si WiFi está conectado.
    HTTPClient http;  // Crea objeto para enviar datos.
    http.begin(serverUrl);  // Apunta a la API.
    http.addHeader("Content-Type", "application/json");  // Dice que envía JSON.
    
    //NO desserializamos, SERIALIZAMOS
    JsonDocument doc;
    //armamos el diccionario
    doc["id_llave"] = uid;
    doc["tipo"] = "entrada"; //Asignamos que este sensor sea para entrada
    // Crea mensaje JSON con ID y tipo (entrada).
    String jsonData;
    serializeJson(doc, jsonData);
    int respuesta = http.POST(jsonData);  // Envía el mensaje.
    
    if (respuesta > 0) {  // Si envió bien.
        Serial.println("Enviado a API: " + http.getString());  // Muestra respuesta.
    } else {  // Si falló.
        Serial.println("Error al enviar");
    }
    http.end();  // Cierra la conexión.
  }

  rfid.PICC_HaltA();  // Apaga la tarjeta para la próxima lectura.
  delay(2000);        // Espera 2 segundos para no leer la misma tarjeta rápido.
}
